
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/Script/common/shader/EffectCommon.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '0e4batwDktDsKv2pkukBcXZ', 'EffectCommon');
// Script/common/shader/EffectCommon.js

"use strict";

var _default_vert = require("ccShader_Default_Vert");

var _default_vert_no_mvp = require("ccShader_Default_Vert_noMVP");

var _wave = require("ccShader_wave");

var Utils = require("Utils");

cc.Class({
  "extends": cc.Component,
  properties: {},
  onLoad: function onLoad() {
    var self = this;
    this.parameters = {
      time: 0.0,
      mouse: {
        x: 0.5,
        y: 0.5
      },
      resolution: {
        x: 0.0,
        y: 0.0
      },
      wavewidth: 6 / 108
    };
    this.node.on(cc.Node.EventType.TOUCH_END, function (event) {
      var delta = event.touch.getLocation();
      delta = this.node.convertToNodeSpace(delta);
      this.parameters.mouse.x = delta.x / this.node.getContentSize().width;
      this.parameters.mouse.y = delta.y / this.node.getContentSize().height; // console.log(this.parameters.mouse);

      this.parameters.time = 0.0;
      this.parameters.wavewidth = 40 / this.node.getContentSize().width;
      this.showWave();
    }, this);
    this._show_wave = false;

    self._use();
  },
  showWave: function showWave() {
    this._show_wave = true;
  },
  update: function update(dt) {
    if (this._program && this._show_wave) {
      this._program.use();

      this.updateGLParameters(dt);

      if (cc.sys.isNative) {
        var glProgram_state = cc.GLProgramState.getOrCreateWithGLProgram(this._program);
        glProgram_state.setUniformFloat("time", this.parameters.time);
        glProgram_state.setUniformVec2("mouse", this.parameters.mouse);
      } else {
        // this._program.setUniformLocationWith2f(this._resolution, this.parameters.resolution.x, this.parameters.resolution.y);
        this._program.setUniformLocationWith1f(this._time, this.parameters.time);

        this._program.setUniformLocationWith2f(this._mouse, this.parameters.mouse.x, 1.0 - this.parameters.mouse.y);
      }
    }
  },
  updateGLParameters: function updateGLParameters(dt) {
    this.parameters.time += dt; // console.log(this.parameters.time)
    // if (this.parameters.time >= 0.1) this._show_wave = false;
  },
  _use: function _use() {
    this._program = new cc.GLProgram();

    if (cc.sys.isNative) {
      cc.log("use native GLProgram");

      this._program.initWithString(_default_vert_no_mvp, _wave);

      this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_POSITION, cc.macro.VERTEX_ATTRIB_POSITION);

      this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_COLOR, cc.macro.VERTEX_ATTRIB_COLOR);

      this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_TEX_COORD, cc.macro.VERTEX_ATTRIB_TEX_COORDS);

      this._program.link();

      this._program.updateUniforms();
    } else {
      this._program.initWithVertexShaderByteArray(_default_vert, _wave);

      this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_POSITION, cc.macro.VERTEX_ATTRIB_POSITION);

      this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_COLOR, cc.macro.VERTEX_ATTRIB_COLOR);

      this._program.addAttribute(cc.macro.ATTRIBUTE_NAME_TEX_COORD, cc.macro.VERTEX_ATTRIB_TEX_COORDS);

      this._program.link();

      this._program.updateUniforms();
    }

    if (cc.sys.isNative) {
      var glProgram_state = cc.GLProgramState.getOrCreateWithGLProgram(this._program);
      glProgram_state.setUniformFloat("time", this.parameters.time);
      glProgram_state.setUniformVec2("mouse", this.parameters.mouse);
    } else {
      this._time = this._program.getUniformLocationForName("time");
      this._mouse = this._program.getUniformLocationForName("mouse");

      this._program.setUniformLocationWith1f(this._time, this.parameters.time);

      this._program.setUniformLocationWith2f(this._mouse, this.parameters.mouse.x, this.parameters.mouse.y);
    }

    this.setProgram(this.node._sgNode, this._program);
  },
  setProgram: function setProgram(node, program) {
    if (cc.sys.isNative) {
      var glProgram_state = cc.GLProgramState.getOrCreateWithGLProgram(program);
      node.setGLProgramState(glProgram_state);
    } else {
      node.setShaderProgram(program);
    }

    var children = node.children;
    if (!children) return;

    for (var i = 0; i < children.length; i++) {
      this.setProgram(children[i], program);
    }
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcU2NyaXB0XFxjb21tb25cXHNoYWRlclxcRWZmZWN0Q29tbW9uLmpzIl0sIm5hbWVzIjpbIl9kZWZhdWx0X3ZlcnQiLCJyZXF1aXJlIiwiX2RlZmF1bHRfdmVydF9ub19tdnAiLCJfd2F2ZSIsIlV0aWxzIiwiY2MiLCJDbGFzcyIsIkNvbXBvbmVudCIsInByb3BlcnRpZXMiLCJvbkxvYWQiLCJzZWxmIiwicGFyYW1ldGVycyIsInRpbWUiLCJtb3VzZSIsIngiLCJ5IiwicmVzb2x1dGlvbiIsIndhdmV3aWR0aCIsIm5vZGUiLCJvbiIsIk5vZGUiLCJFdmVudFR5cGUiLCJUT1VDSF9FTkQiLCJldmVudCIsImRlbHRhIiwidG91Y2giLCJnZXRMb2NhdGlvbiIsImNvbnZlcnRUb05vZGVTcGFjZSIsImdldENvbnRlbnRTaXplIiwid2lkdGgiLCJoZWlnaHQiLCJzaG93V2F2ZSIsIl9zaG93X3dhdmUiLCJfdXNlIiwidXBkYXRlIiwiZHQiLCJfcHJvZ3JhbSIsInVzZSIsInVwZGF0ZUdMUGFyYW1ldGVycyIsInN5cyIsImlzTmF0aXZlIiwiZ2xQcm9ncmFtX3N0YXRlIiwiR0xQcm9ncmFtU3RhdGUiLCJnZXRPckNyZWF0ZVdpdGhHTFByb2dyYW0iLCJzZXRVbmlmb3JtRmxvYXQiLCJzZXRVbmlmb3JtVmVjMiIsInNldFVuaWZvcm1Mb2NhdGlvbldpdGgxZiIsIl90aW1lIiwic2V0VW5pZm9ybUxvY2F0aW9uV2l0aDJmIiwiX21vdXNlIiwiR0xQcm9ncmFtIiwibG9nIiwiaW5pdFdpdGhTdHJpbmciLCJhZGRBdHRyaWJ1dGUiLCJtYWNybyIsIkFUVFJJQlVURV9OQU1FX1BPU0lUSU9OIiwiVkVSVEVYX0FUVFJJQl9QT1NJVElPTiIsIkFUVFJJQlVURV9OQU1FX0NPTE9SIiwiVkVSVEVYX0FUVFJJQl9DT0xPUiIsIkFUVFJJQlVURV9OQU1FX1RFWF9DT09SRCIsIlZFUlRFWF9BVFRSSUJfVEVYX0NPT1JEUyIsImxpbmsiLCJ1cGRhdGVVbmlmb3JtcyIsImluaXRXaXRoVmVydGV4U2hhZGVyQnl0ZUFycmF5IiwiZ2V0VW5pZm9ybUxvY2F0aW9uRm9yTmFtZSIsInNldFByb2dyYW0iLCJfc2dOb2RlIiwicHJvZ3JhbSIsInNldEdMUHJvZ3JhbVN0YXRlIiwic2V0U2hhZGVyUHJvZ3JhbSIsImNoaWxkcmVuIiwiaSIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxJQUFJQSxhQUFhLEdBQUdDLE9BQU8sQ0FBQyx1QkFBRCxDQUEzQjs7QUFDQSxJQUFJQyxvQkFBb0IsR0FBR0QsT0FBTyxDQUFDLDZCQUFELENBQWxDOztBQUNBLElBQUlFLEtBQUssR0FBR0YsT0FBTyxDQUFDLGVBQUQsQ0FBbkI7O0FBR0EsSUFBSUcsS0FBSyxHQUFHSCxPQUFPLENBQUMsT0FBRCxDQUFuQjs7QUFDQUksRUFBRSxDQUFDQyxLQUFILENBQVM7QUFDTCxhQUFTRCxFQUFFLENBQUNFLFNBRFA7QUFHTEMsRUFBQUEsVUFBVSxFQUFFLEVBSFA7QUFNTEMsRUFBQUEsTUFBTSxFQUFFLGtCQUFZO0FBQ2hCLFFBQUlDLElBQUksR0FBRyxJQUFYO0FBQ0EsU0FBS0MsVUFBTCxHQUFrQjtBQUNkQyxNQUFBQSxJQUFJLEVBQUUsR0FEUTtBQUVkQyxNQUFBQSxLQUFLLEVBQUU7QUFDSEMsUUFBQUEsQ0FBQyxFQUFFLEdBREE7QUFFSEMsUUFBQUEsQ0FBQyxFQUFFO0FBRkEsT0FGTztBQU1kQyxNQUFBQSxVQUFVLEVBQUU7QUFDUkYsUUFBQUEsQ0FBQyxFQUFFLEdBREs7QUFFUkMsUUFBQUEsQ0FBQyxFQUFFO0FBRkssT0FORTtBQVVkRSxNQUFBQSxTQUFTLEVBQUUsSUFBSTtBQVZELEtBQWxCO0FBWUEsU0FBS0MsSUFBTCxDQUFVQyxFQUFWLENBQWFkLEVBQUUsQ0FBQ2UsSUFBSCxDQUFRQyxTQUFSLENBQWtCQyxTQUEvQixFQUEwQyxVQUFVQyxLQUFWLEVBQWlCO0FBQ3ZELFVBQUlDLEtBQUssR0FBR0QsS0FBSyxDQUFDRSxLQUFOLENBQVlDLFdBQVosRUFB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UUFBUSxDQUFDQyxDQUFELENBQXhCLEVBQTZCSixPQUE3QjtBQURKO0FBRUg7QUEvR0ksQ0FBVCIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF9kZWZhdWx0X3ZlcnQgPSByZXF1aXJlKFwiY2NTaGFkZXJfRGVmYXVsdF9WZXJ0XCIpO1xudmFyIF9kZWZhdWx0X3ZlcnRfbm9fbXZwID0gcmVxdWlyZShcImNjU2hhZGVyX0RlZmF1bHRfVmVydF9ub01WUFwiKTtcbnZhciBfd2F2ZSA9IHJlcXVpcmUoXCJjY1NoYWRlcl93YXZlXCIpO1xuXG5cbnZhciBVdGlscyA9IHJlcXVpcmUoXCJVdGlsc1wiKTtcbmNjLkNsYXNzKHtcbiAgICBleHRlbmRzOiBjYy5Db21wb25lbnQsXG5cbiAgICBwcm9wZXJ0aWVzOiB7XG4gICAgfSxcblxuICAgIG9uTG9hZDogZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIHRoaXMucGFyYW1ldGVycyA9IHtcbiAgICAgICAgICAgIHRpbWU6IDAuMCxcbiAgICAgICAgICAgIG1vdXNlOiB7XG4gICAgICAgICAgICAgICAgeDogMC41LFxuICAgICAgICAgICAgICAgIHk6IDAuNSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZXNvbHV0aW9uOiB7XG4gICAgICAgICAgICAgICAgeDogMC4wLFxuICAgICAgICAgICAgICAgIHk6IDAuMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB3YXZld2lkdGg6IDYgLyAxMDgsXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMubm9kZS5vbihjYy5Ob2RlLkV2ZW50VHlwZS5UT1VDSF9FTkQsIGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgbGV0IGRlbHRhID0gZXZlbnQudG91Y2guZ2V0TG9jYXRpb24oKTtcbiAgICAgICAgICAgIGRlbHRhID0gdGhpcy5ub2RlLmNvbnZlcnRUb05vZGVTcGFjZShkZWx0YSk7XG4gICAgICAgICAgICB0aGlzLnBhcmFtZXRlcnMubW91c2UueCA9IGRlbHRhLnggLyB0aGlzLm5vZGUuZ2V0Q29udGVudFNpemUoKS53aWR0aDtcbiAgICAgICAgICAgIHRoaXMucGFyYW1ldGVycy5tb3VzZS55ID0gZGVsdGEueSAvIHRoaXMubm9kZS5nZXRDb250ZW50U2l6ZSgpLmhlaWdodDtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHRoaXMucGFyYW1ldGVycy5tb3VzZSk7XG4gICAgICAgICAgICB0aGlzLnBhcmFtZXRlcnMudGltZSA9IDAuMDtcbiAgICAgICAgICAgIHRoaXMucGFyYW1ldGVycy53YXZld2lkdGggPSA0MCAvIHRoaXMubm9kZS5nZXRDb250ZW50U2l6ZSgpLndpZHRoO1xuICAgICAgICAgICAgdGhpcy5zaG93V2F2ZSgpO1xuICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgdGhpcy5fc2hvd193YXZlID0gZmFsc2U7XG4gICAgICAgIHNlbGYuX3VzZSgpO1xuXG4gICAgfSxcblxuICAgIHNob3dXYXZlKCkge1xuICAgICAgICB0aGlzLl9zaG93X3dhdmUgPSB0cnVlO1xuICAgIH0sXG5cbiAgICB1cGRhdGU6IGZ1bmN0aW9uIChkdCkge1xuICAgICAgICBpZiAodGhpcy5fcHJvZ3JhbSAmJiB0aGlzLl9zaG93X3dhdmUpIHtcbiAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0udXNlKCk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUdMUGFyYW1ldGVycyhkdCk7XG4gICAgICAgICAgICBpZiAoY2Muc3lzLmlzTmF0aXZlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGdsUHJvZ3JhbV9zdGF0ZSA9IGNjLkdMUHJvZ3JhbVN0YXRlLmdldE9yQ3JlYXRlV2l0aEdMUHJvZ3JhbSh0aGlzLl9wcm9ncmFtKTtcbiAgICAgICAgICAgICAgICBnbFByb2dyYW1fc3RhdGUuc2V0VW5pZm9ybUZsb2F0KFwidGltZVwiLCB0aGlzLnBhcmFtZXRlcnMudGltZSk7XG4gICAgICAgICAgICAgICAgZ2xQcm9ncmFtX3N0YXRlLnNldFVuaWZvcm1WZWMyKFwibW91c2VcIiwgdGhpcy5wYXJhbWV0ZXJzLm1vdXNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gdGhpcy5fcHJvZ3JhbS5zZXRVbmlmb3JtTG9jYXRpb25XaXRoMmYodGhpcy5fcmVzb2x1dGlvbiwgdGhpcy5wYXJhbWV0ZXJzLnJlc29sdXRpb24ueCwgdGhpcy5wYXJhbWV0ZXJzLnJlc29sdXRpb24ueSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fcHJvZ3JhbS5zZXRVbmlmb3JtTG9jYXRpb25XaXRoMWYodGhpcy5fdGltZSwgdGhpcy5wYXJhbWV0ZXJzLnRpbWUpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0uc2V0VW5pZm9ybUxvY2F0aW9uV2l0aDJmKHRoaXMuX21vdXNlLCB0aGlzLnBhcmFtZXRlcnMubW91c2UueCwgMS4wLXRoaXMucGFyYW1ldGVycy5tb3VzZS55KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgXG4gICAgdXBkYXRlR0xQYXJhbWV0ZXJzKGR0KSB7XG4gICAgICAgIHRoaXMucGFyYW1ldGVycy50aW1lICs9IGR0O1xuICAgICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLnBhcmFtZXRlcnMudGltZSlcbiAgICAgICAgLy8gaWYgKHRoaXMucGFyYW1ldGVycy50aW1lID49IDAuMSkgdGhpcy5fc2hvd193YXZlID0gZmFsc2U7XG4gICAgfSxcblxuICAgIF91c2U6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5fcHJvZ3JhbSA9IG5ldyBjYy5HTFByb2dyYW0oKTtcbiAgICAgICAgaWYgKGNjLnN5cy5pc05hdGl2ZSkge1xuICAgICAgICAgICAgY2MubG9nKFwidXNlIG5hdGl2ZSBHTFByb2dyYW1cIik7XG4gICAgICAgICAgICB0aGlzLl9wcm9ncmFtLmluaXRXaXRoU3RyaW5nKF9kZWZhdWx0X3ZlcnRfbm9fbXZwLCBfd2F2ZSk7XG4gICAgICAgICAgICB0aGlzLl9wcm9ncmFtLmFkZEF0dHJpYnV0ZShjYy5tYWNyby5BVFRSSUJVVEVfTkFNRV9QT1NJVElPTiwgY2MubWFjcm8uVkVSVEVYX0FUVFJJQl9QT1NJVElPTik7XG4gICAgICAgICAgICB0aGlzLl9wcm9ncmFtLmFkZEF0dHJpYnV0ZShjYy5tYWNyby5BVFRSSUJVVEVfTkFNRV9DT0xPUiwgY2MubWFjcm8uVkVSVEVYX0FUVFJJQl9DT0xPUik7XG4gICAgICAgICAgICB0aGlzLl9wcm9ncmFtLmFkZEF0dHJpYnV0ZShjYy5tYWNyby5BVFRSSUJVVEVfTkFNRV9URVhfQ09PUkQsIGNjLm1hY3JvLlZFUlRFWF9BVFRSSUJfVEVYX0NPT1JEUyk7XG5cbiAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0ubGluaygpO1xuICAgICAgICAgICAgdGhpcy5fcHJvZ3JhbS51cGRhdGVVbmlmb3JtcygpO1xuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICB0aGlzLl9wcm9ncmFtLmluaXRXaXRoVmVydGV4U2hhZGVyQnl0ZUFycmF5KF9kZWZhdWx0X3ZlcnQsIF93YXZlKTtcbiAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0uYWRkQXR0cmlidXRlKGNjLm1hY3JvLkFUVFJJQlVURV9OQU1FX1BPU0lUSU9OLCBjYy5tYWNyby5WRVJURVhfQVRUUklCX1BPU0lUSU9OKTtcbiAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0uYWRkQXR0cmlidXRlKGNjLm1hY3JvLkFUVFJJQlVURV9OQU1FX0NPTE9SLCBjYy5tYWNyby5WRVJURVhfQVRUUklCX0NPTE9SKTtcbiAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0uYWRkQXR0cmlidXRlKGNjLm1hY3JvLkFUVFJJQlVURV9OQU1FX1RFWF9DT09SRCwgY2MubWFjcm8uVkVSVEVYX0FUVFJJQl9URVhfQ09PUkRTKTtcblxuICAgICAgICAgICAgdGhpcy5fcHJvZ3JhbS5saW5rKCk7XG4gICAgICAgICAgICB0aGlzLl9wcm9ncmFtLnVwZGF0ZVVuaWZvcm1zKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2Muc3lzLmlzTmF0aXZlKSB7XG4gICAgICAgICAgICB2YXIgZ2xQcm9ncmFtX3N0YXRlID0gY2MuR0xQcm9ncmFtU3RhdGUuZ2V0T3JDcmVhdGVXaXRoR0xQcm9ncmFtKHRoaXMuX3Byb2dyYW0pO1xuICAgICAgICAgICAgZ2xQcm9ncmFtX3N0YXRlLnNldFVuaWZvcm1GbG9hdChcInRpbWVcIiwgdGhpcy5wYXJhbWV0ZXJzLnRpbWUpO1xuICAgICAgICAgICAgZ2xQcm9ncmFtX3N0YXRlLnNldFVuaWZvcm1WZWMyKFwibW91c2VcIiwgdGhpcy5wYXJhbWV0ZXJzLm1vdXNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3RpbWUgPSB0aGlzLl9wcm9ncmFtLmdldFVuaWZvcm1Mb2NhdGlvbkZvck5hbWUoXCJ0aW1lXCIpO1xuICAgICAgICAgICAgdGhpcy5fbW91c2UgPSB0aGlzLl9wcm9ncmFtLmdldFVuaWZvcm1Mb2NhdGlvbkZvck5hbWUoXCJtb3VzZVwiKTtcbiAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0uc2V0VW5pZm9ybUxvY2F0aW9uV2l0aDFmKHRoaXMuX3RpbWUsIHRoaXMucGFyYW1ldGVycy50aW1lKTtcbiAgICAgICAgICAgIHRoaXMuX3Byb2dyYW0uc2V0VW5pZm9ybUxvY2F0aW9uV2l0aDJmKHRoaXMuX21vdXNlLCB0aGlzLnBhcmFtZXRlcnMubW91c2UueCwgdGhpcy5wYXJhbWV0ZXJzLm1vdXNlLnkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRQcm9ncmFtKHRoaXMubm9kZS5fc2dOb2RlLCB0aGlzLl9wcm9ncmFtKTtcbiAgICB9LFxuXG4gICAgc2V0UHJvZ3JhbTogZnVuY3Rpb24gKG5vZGUsIHByb2dyYW0pIHtcbiAgICAgICAgaWYgKGNjLnN5cy5pc05hdGl2ZSkge1xuICAgICAgICAgICAgdmFyIGdsUHJvZ3JhbV9zdGF0ZSA9IGNjLkdMUHJvZ3JhbVN0YXRlLmdldE9yQ3JlYXRlV2l0aEdMUHJvZ3JhbShwcm9ncmFtKTtcbiAgICAgICAgICAgIG5vZGUuc2V0R0xQcm9ncmFtU3RhdGUoZ2xQcm9ncmFtX3N0YXRlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vZGUuc2V0U2hhZGVyUHJvZ3JhbShwcm9ncmFtKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBjaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW47XG4gICAgICAgIGlmICghY2hpbGRyZW4pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKylcbiAgICAgICAgICAgIHRoaXMuc2V0UHJvZ3JhbShjaGlsZHJlbltpXSwgcHJvZ3JhbSlcbiAgICB9XG5cbn0pO1xuIl19